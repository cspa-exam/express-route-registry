#!/bin/bash
#
# This is a convenience script I use for uploading code to the test environment
#
set -e

#
# Get to project root
#
cd "$(dirname "$0")/.."

# It is always at ".", since this script pegs it with the above statement

LOCAL_DIR="./"
REMOTE_DIR="cspadev:~/repos/express-route-registry/"


# Use rsync to bring all files from local to the remote
#
# Flags:
#  -a Archive mode: It combines the -rlptgoD options together.  This handles recursive traversal and preserving
#       symlinks, file modification times, and permissions.
#  -r Recursive (note, I found a trick where you need to postfix the source with a dot "." to get this to work properly)
#  -b Backs up the files on the destination when there are conflicts (Don't do this this is super annoying)
#  -d Deletes files that are not recognized
#  -u Ignore files on the destination that are newer (this is enabled on the source->dest, not the other way around!)
#  -v Verbose
COMMON_OPTIONS="--progress \
  --delete \
  --exclude .git \
  --exclude .idea \
  --exclude .DS_Store \
  --exclude node_modules \
  "

UPLOAD="rsync -avu $LOCAL_DIR. $REMOTE_DIR \
  $COMMON_OPTIONS"

DOWNLOAD="rsync -avu $REMOTE_DIR. $LOCAL_DIR \
  $COMMON_OPTIONS"

MODE="$1"

if [ "$MODE" = "down" ]; then
  echo ">> Downloading files..."
  $DOWNLOAD

  echo ">> Uploading files..."
  $UPLOAD
else
  echo ">> Uploading files..."
  $UPLOAD

  echo ">> Downloading files..."
  $DOWNLOAD
fi
